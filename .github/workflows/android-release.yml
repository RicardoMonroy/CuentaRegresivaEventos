name: Android Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17 (Temurin)
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Display Java version
      run: |
        java -version
        echo "JAVA_HOME: $JAVA_HOME"
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Build Release APK (with retry)
      uses: nick-invision/retry@v2
      with:
        timeout_minutes: 15
        max_attempts: 3
        command: |
          ./gradlew assembleRelease --no-daemon --refresh-dependencies --stacktrace
          
    - name: Build Debug APK (with retry)  
      uses: nick-invision/retry@v2
      with:
        timeout_minutes: 10
        max_attempts: 2
        command: |
          ./gradlew assembleDebug --no-daemon --refresh-dependencies --stacktrace
      
    - name: Get version name
      id: version
      run: echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
      
    - name: Verify APKs exist
      run: |
        echo "=== Checking Release APK ==="
        ls -la app/build/outputs/apk/release/ || echo "Release APK directory not found"
        if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
          echo "‚úÖ Release APK found: $(ls -la app/build/outputs/apk/release/app-release.apk)"
        else
          echo "‚ùå Release APK not found"
          echo "Contents of release directory:"
          find app/build/outputs/apk/release/ -type f || echo "No files in release directory"
        fi
        
        echo "=== Checking Debug APK ==="
        ls -la app/build/outputs/apk/debug/ || echo "Debug APK directory not found"
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          echo "‚úÖ Debug APK found: $(ls -la app/build/outputs/apk/debug/app-debug.apk)"
        else
          echo "‚ùå Debug APK not found"
          echo "Contents of debug directory:"
          find app/build/outputs/apk/debug/ -type f || echo "No files in debug directory"
        fi
        
    - name: List all APK files
      run: |
        echo "=== All APK files in project ==="
        find app/build -name "*.apk" -type f || echo "No APK files found in build directory"
        
    - name: Upload Release APK
      uses: softprops/action-gh-release@v1
      if: success() && (hashFiles('app/build/outputs/apk/release/app-release.apk') != '')
      with:
        files: |
          app/build/outputs/apk/release/app-release.apk
          app/build/outputs/apk/debug/app-debug.apk
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          üéâ **Cuenta Regresiva Eventos - Release ${{ github.ref_name }}**
          
          üì± **Descargas disponibles:**
          - `app-release.apk` - Versi√≥n de producci√≥n
          - `app-debug.apk` - Versi√≥n de desarrollo
          
          ‚ú® **Caracter√≠sticas incluidas:**
          - ‚úÖ Widget mejorado con scroll
          - ‚úÖ Formato de fecha en espa√±ol
          - ‚úÖ Modal dialog optimizado
          - ‚úÖ UI/UX mejorada
          - ‚úÖ Funcionalidad completa de countdown
          
          üõ†Ô∏è **Compilado con:**
          - Java 17 (Eclipse Temurin)
          - Android SDK 34
          - Kotlin 2.0
          
          üìã **Changelog:**
          ${{ github.event.head_commit.message }}
          
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}